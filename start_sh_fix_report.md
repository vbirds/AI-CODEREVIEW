# start.sh 脚本修复报告

## 修复时间
2025-06-25

## 修复目标
将 start.sh 脚本从多容器架构模式改为单容器架构模式，并确保端口配置正确使用5001和5002。

## 主要修改内容

### 1. 脚本架构调整
- **标题更新**: 从"AI-CodeReview-Gitlab 智能启动脚本 - 支持多容器和单容器模式选择" 改为 "AI-CodeReview 智能启动脚本 - 单容器架构"
- **版本更新**: 从 "版本: 2.1 | 支持多容器/单容器部署" 改为 "版本: 3.0 | 单容器架构 - API+Worker+UI 三合一"

### 2. 菜单系统重构
- **主菜单**: 简化为单容器模式的操作选项
  - 启动服务 (支持基础模式和Redis模式)
  - 停止服务
  - 查看服务状态
  - 查看服务日志
  - 重启服务
  - 清理Docker资源
  - 安装/更新环境
  - 下载配置文件

### 3. 功能函数重构
- **删除**: `multi_container_menu()` 和 `single_container_menu()` 函数
- **新增**: `start_service_menu()` 函数，支持基础模式和Redis模式
- **简化**: `stop_all_services()` 改为 `stop_service()`
- **新增**: `restart_service()` 函数

### 4. 端口配置修正
- **API服务端口**: 8080 → 5001
- **UI服务端口**: 8081 → 5002
- **Redis端口**: 保持6379不变

### 5. 健康检查优化
- 更新所有健康检查URL为正确的端口
- 修正端口占用检查逻辑
- 优化服务地址显示信息

### 6. 预检查更新
- 端口冲突检查现在检查5001、5002、6379端口
- 移除多容器相关的检查逻辑

## 修改的具体位置

### 端口相关修改
1. **启动成功后的服务地址显示** (3处)
   - 基础模式启动成功: 5001, 5002
   - Redis模式启动成功: 5001, 5002, 6379
   - 重启服务成功: 5001, 5002

2. **健康检查函数**
   - API健康检查: http://localhost:5001/health 和 http://localhost:5001
   - UI健康检查: http://localhost:5002
   - 端口占用检查: :5001 和 :5002

3. **服务访问地址显示**
   - 健康检查通过后的地址显示: 5001, 5002
   - 部分服务通过时的地址显示: 5001, 5002

4. **端口冲突预检查**
   - 检查端口列表: [5001, 5002, 6379]

### 架构相关修改
1. **主循环逻辑**
   - 选项1: 调用 `start_service_menu`
   - 选项2: 调用 `stop_service`
   - 选项3-5: 状态查看、日志查看、重启服务

2. **启动服务菜单**
   - 选项1: 基础模式 (内存队列)
   - 选项2: Redis模式 (Redis队列)

## 配置文件依赖
- **主配置**: docker-compose.yml (单服务架构)
- **备用配置**: 不再使用 docker-compose.single.yml
- **容器配置**: 统一使用单个 ai-codereview 服务

## 测试验证
- [x] 语法检查通过
- [x] 端口引用全部修正
- [x] 菜单逻辑简化完成
- [x] 健康检查端口正确

## 兼容性说明
- 脚本现在专为单容器架构设计
- 移除了多容器模式的复杂性
- 保持了Redis可选支持
- 维护了完整的日志和状态监控功能

## 后续建议
1. 测试脚本在实际环境中的运行情况
2. 验证健康检查的准确性
3. 考虑添加更详细的错误诊断信息
4. 可能需要根据实际使用情况微调超时和重试参数
