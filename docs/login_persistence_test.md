# UI 网页刷新不退出账号 - 测试说明

## 🔧 实现原理

新的登录持久化机制采用了**双重保障**的设计：

### 1. URL参数持久化
- 登录成功后，在URL中添加 `?auto_login=true&user=用户名`
- 页面刷新时会保留URL参数
- 初始化时检查URL参数，自动恢复登录状态

### 2. 临时文件持久化
- 登录成功后，在系统临时目录创建 `streamlit_ai_codereview_session.json`
- 包含用户名、时间戳、认证状态
- 24小时有效期，过期自动失效
- 作为URL参数的备份方案

## 📋 测试步骤

### 测试1: 基本刷新保持登录
1. 打开 http://localhost:8501
2. 输入用户名和密码登录
3. 登录成功后，注意URL会变为 `http://localhost:8501/?auto_login=true&user=用户名`
4. 按 `F5` 或 `Ctrl+R` 刷新页面
5. **期望结果**: 页面刷新后仍保持登录状态，不需要重新输入密码

### 测试2: 新标签页保持登录
1. 在已登录的页面中，复制当前URL
2. 打开新标签页，粘贴URL并访问
3. **期望结果**: 新标签页中也应该保持登录状态

### 测试3: 浏览器重启后保持登录（24小时内）
1. 登录成功后，完全关闭浏览器
2. 重新打开浏览器，访问 http://localhost:8501
3. **期望结果**: 如果在24小时内，应该自动恢复登录状态

### 测试4: 注销功能
1. 在已登录状态下，点击右上角的注销按钮（🚪）
2. **期望结果**: 
   - 成功注销，返回登录页面
   - URL参数被清理
   - 临时文件被删除
   - 再次刷新页面不会自动登录

## 🔍 故障排除

### 如果刷新后仍然退出登录：

1. **检查URL参数**
   - 登录成功后，检查浏览器地址栏是否包含 `?auto_login=true&user=xxx`
   - 如果没有，说明URL参数设置失败

2. **检查临时文件**
   - Windows: 检查 `%TEMP%\streamlit_ai_codereview_session.json` 是否存在
   - 文件内容应该包含用户名和时间戳

3. **检查控制台错误**
   - 打开浏览器开发者工具 (F12)
   - 查看控制台是否有JavaScript错误
   - 查看网络请求是否正常

4. **检查Streamlit版本**
   - 确保Streamlit版本支持 `st.query_params` 功能
   - 建议使用 Streamlit 1.28.0 或更高版本

## 🔒 安全考虑

- URL参数中只包含用户名，不包含密码或其他敏感信息
- 临时文件有24小时有效期，自动过期
- 注销时会完全清理所有持久化数据
- 文件存储在系统临时目录，具有适当的权限控制

## 🎯 使用建议

1. **正常使用**: 登录一次后，可以自由刷新页面而不会丢失状态
2. **长期使用**: 24小时内无需重复登录
3. **安全退出**: 使用注销功能而不是直接关闭浏览器
4. **多标签页**: 可以在多个标签页中同时使用，共享登录状态

如果以上功能仍然不能正常工作，请检查：
- Streamlit应用是否正常运行
- 文件系统权限是否允许创建临时文件
- 浏览器是否支持URL参数功能
